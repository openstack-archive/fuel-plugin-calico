# Copyright 2015 Metaswitch Networks

# Install/configure calico on the controller after cluster deployment
# but before starting the BGP Route Reflector.
- id: calico-controller
  role: ['controller', 'primary-controller']
  version: 2.0.0
  requires: [post_deployment_start]
  type: shell
  parameters:
    cmd: ./calico_controller.sh
    timeout: 600

- id: calico-route-reflector
  role: ['controller', 'primary-controller']
  version: 2.0.0
  requires: [post_deployment_start, calico-controller]
  type: shell
  parameters:
    cmd: ./calico_route_reflector.sh
    timeout: 60

- id: calico-networks
  role: ['primary-controller']
  version: 2.0.0
  requires: [post_deployment_start, calico-controller]
  type: puppet
  parameters:
    timeout: 180
    puppet_manifest: neutron-networks.pp
    puppet_modules: puppet/modules:/etc/puppet/modules


# Remove default OpenStack network configuration which doesn't work with Calico.
#- role: ['primary-controller']
#  stage: post_deployment/150
#  type: shell
#  parameters:
#    cmd: ./remove_default_networks.sh
#    timeout: 60

# Install/configure calico on the compute nodes after cluster deployment.
- id: calico-compute
  role: ['compute']
  version: 2.0.0
  requires: [post_deployment_start]
  type: shell
  parameters:
    cmd: ./calico_compute.sh
    timeout: 600


- id: neutron-br-int-workaround
  groups: [compute]
  version: 2.1.0
  requires: [openstack-network-start]
  required_for: [openstack-network-end, enable_nova_compute_service]
  type: puppet
  parameters:
    timeout: 180
    puppet_manifest: neutron-br-int-workaround.pp
    puppet_modules: puppet/modules:/etc/puppet/modules


# Disable tasks that create neutron router and networks
- id: openstack-network-networks
  groups: ["/.*/"]
  version: 2.1.0
  type: skipped

- id: openstack-network-routers
  groups: ["/.*/"]
  version: 2.1.0
  type: skipped

- id: primary-openstack-network-agents-dhcp
  groups: ["/.*/"]
  version: 2.1.0
  type: skipped
- id: openstack-network-agents-dhcp
  groups: ["/.*/"]
  version: 2.1.0
  type: skipped

- id: primary-openstack-network-plugins-l2
  groups: ["/.*/"]
  version: 2.1.0
  type: skipped
- id: openstack-network-plugins-l2
  groups: ["/.*/"]
  version: 2.1.0
  type: skipped

- id: primary-openstack-network-agents-l3
  groups: ["/.*/"]
  version: 2.1.0
  type: skipped
- id: openstack-network-agents-l3
  groups: ["/.*/"]
  version: 2.1.0
  type: skipped

- id: primary-openstack-network-agents-metadata
  groups: ["/.*/"]
  version: 2.1.0
  type: skipped
- id: openstack-network-agents-metadata
  groups: ["/.*/"]
  version: 2.1.0
  type: skipped
